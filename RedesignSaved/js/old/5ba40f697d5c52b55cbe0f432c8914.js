$(document).ready(function(){if(exodus.ready==false){exodus.ready=true;exodus.createIndicator();var a=function(c){if($("#exodus-timer").hasClass("end-soon")){return}if(c<86400){$("#exodus-timer").addClass("end-soon")}};var b=parseInt($("#exodus-timer").text());a(b);new simpleCountdown(getElementByIdWithCache("exodus-timer"),b,function(){$("#exodus-timer").remove()},function(c){a(c)})}});var exodus={ready:false,noServers:true,secondaryShown:false,createIndicator:function(){exodus.indicator=$("#exodus-indicator");if(exodus.indicator.length>0){exodus.indicator.bind("click",exodus.showDialog)}},appendServerRow:function(b,g,f,d){var c=(exodus.data["migration-host"]==g.host);var a=$('<li class="'+(exodus.odd++%2?"odd":"even")+'" id="server-'+g.id+'"/>').bind("click",function(){if($(this).hasClass("disabled")){return}else{if($(this).hasClass("row-selected")){exodus.confirmButton.removeClass("confirm");$(this).removeClass("row-selected");exodus.markedServer=null}else{exodus.markedServer=g;if(exodus.markedServer!=exodus.selectedServer){exodus.confirmButton.addClass("confirm")}else{if(exodus.confirmButton.hasClass("confirm")){exodus.confirmButton.removeClass("confirm")}}b.find("li").removeClass("row-selected");$(this).addClass("row-selected")}}}).hide().append($('<span class="exodus-universe-treeview-column-checkbox"/>').append($("<span/>"))).append($('<span class="exodus-universe-treeview-column-name"/>').text(g.name)).append($('<span class="exodus-universe-treeview-column-startdate"/>').text(g.since)).append($('<span class="exodus-universe-treeview-column-free-spaces"/>')).append($('<span class="exodus-universe-treeview-column-features"/>').text(g.features));b.append(a);var e=$('<li id="wait-server-'+g.id+'"/>').append($('<img alt="'+exodus.data.translations["loading"]+'" src="'+exodus.data["load-image"]+'"/>'));b.append(e);if(c){exodus.markedServer=g;exodus.selectedServer=g;a.addClass("server-selected");a.addClass("row-selected")}$.jsonp({url:"http://"+g.host+"/service/exodus.php?action=getServerInfo&data="+g.data+"&callback=?",error:function(){exodus.handleError(g.id,exodus.data.translations["error-no-server"]);$("#server-"+g.id).show();$("#wait-server-"+g.id).remove();if(exodus.noServers&&f){showSecondaryServers(b)}},success:function(h){if(!h.currentPlayerCount){exodus.handleError(g.id,exodus.data.translations["error-no-server"]);$("#server-"+g.id).show();$("#wait-server-"+g.id).remove();return}$("#server-"+g.id+" .exodus-universe-treeview-column-free-spaces").text(h.freeSlots);if(h.alreadyMigrating){exodus.handleSuccess(g.id,exodus.data.translations["success-server-selected"]);if(!d){exodus.noServers=false}}else{if(h.alreadyRegistered){exodus.handleError(g.id,exodus.data.translations["error-account"])}else{if(h.usernameInUse){exodus.handleError(g.id,exodus.data.translations["error-name-in-use"])}else{if(h.freeSlots<=0){exodus.handleError(g.id,exodus.data.translations["error-no-free-slots"])}else{if(!d){exodus.noServers=false}}}}}if(exodus.noServers&&f){exodus.showSecondaryServers(b)}$("#server-"+g.id).show();$("#wait-server-"+g.id).remove()}})},handleError:function(a,b){$("#server-"+a).find("span.exodus-success").remove();$("#server-"+a).find("span.exodus-error").remove();$("#server-"+a).append('<span class="exodus-error"><b>'+exodus.data.translations["error-impossible"]+"</b><br/>"+b+"</span>");$("#server-"+a).addClass("disabled")},handleSuccess:function(a,b){$("#server-"+a).find("span.exodus-success").remove();$("#server-"+a).find("span.exodus-error").remove();$("#server-"+a).append('<span class="exodus-success"><b>'+b+"</b></span>")},showSelectionTab:function(){exodus.universeTreeviewHeader=$('<div id="exodus-universe-treeview-header"/>').append($('<span class="exodus-universe-treeview-column-checkbox"/>').text("\u2714").css("visibility","hidden")).append($('<span class="exodus-universe-treeview-column-name"/>').text(exodus.data.translations["uni-selection-name"])).append($('<span class="exodus-universe-treeview-column-startdate"/>').text(exodus.data.translations["uni-selection-start"])).append($('<span class="exodus-universe-treeview-column-free-spaces"/>').text(exodus.data.translations["uni-selection-free-spaces"])).append($('<span class="exodus-universe-treeview-column-features"/>').text(exodus.data.translations["uni-selection-specifics"]));var a=$('<ul id="exodus-universe-treeview"/>');exodus.confirmButton=exodus.createButton(exodus.data.translations["uni-selection-confirm"]);exodus.revertButton=exodus.createButton(exodus.data.translations["uni-selection-revert"]);exodus.confirmButton.bind("click",function(){if(!$(this).hasClass("confirm")||exodus.markedServer==null){return}var d=exodus.markedServer;$.jsonp({url:"http://"+d.host+"/service/exodus.php?action=requestMigration&data="+d.data+"&callback=?",error:function(){exodus.handleError(d.id,exodus.data.translations["error-no-server"])},success:function(f){if(f.errorMessage){exodus.handleError(d.id,exodus.data.translations["error-no-server"])}else{if(exodus.selectedServer!=null){a.find("li").removeClass("row-selected");a.find("li").removeClass("server-selected");$("#server-"+exodus.selectedServer.id).find("span.exodus-success").remove();$("#server-"+exodus.selectedServer.id).find("span.exodus-error").remove()}exodus.indicator.attr("data-migration-host",d.host);exodus.data["migration-host"]=d.host;$("#exodus-indicator-waiting").attr("id","exodus-indicator-acknowledged");exodus.handleSuccess(d.id,exodus.data.translations["success-server-selected"]);exodus.revertButton.addClass("cancel");$("#server-"+d.id).addClass("server-selected");exodus.selectedServer=d;var e=$("#server-"+d.id).find("span.exodus-universe-treeview-column-free-players");e.text(parseInt(e.text())-1);exodus.confirmButton.removeClass("confirm")}}})});exodus.revertButton.bind("click",function(){if(!$(this).hasClass("cancel")||exodus.selectedServer==null){return}var d=exodus.selectedServer;$.jsonp({url:"http://"+d.host+"/service/exodus.php?action=cancelMigration&data="+d.data+"&callback=?",error:function(){exodus.closeDialog()},success:function(f){if(f.errorMessage){exodus.closeDialog()}else{exodus.indicator.attr("data-migration-host","");$("#exodus-indicator-acknowledged").attr("id","exodus-indicator-waiting");a.find("li").removeClass("row-selected");a.find("li").removeClass("server-selected");$("#server-"+d.id).find("span.exodus-success").remove();$("#server-"+d.id).find("span.exodus-error").remove();exodus.confirmButton.removeClass("confirm");exodus.revertButton.removeClass("cancel");var e=$("#server-"+d.id).find("span.exodus-universe-treeview-column-free-players");e.text(parseInt(e.text())+1);exodus.markedServer=null;exodus.selectedServer=null}}})});if(exodus.data["migration-host"]!=""){exodus.revertButton.addClass("cancel")}exodus.tabContent.append(exodus.universeTreeviewHeader).append(a).append(exodus.confirmButton).append(exodus.revertButton);exodus.odd=0;for(var b=0;b<exodus.data["primary-servers"].length;b++){var c=(exodus.data["primary-servers"].length==b+1);exodus.appendServerRow(a,exodus.data["primary-servers"][b],c,false)}if(!exodus.secondaryShown){for(var b=0;b<exodus.data["secondary-servers"].length;b++){if(exodus.data["migration-host"]==exodus.data["secondary-servers"][b]["host"]){exodus.appendServerRow(a,exodus.data["secondary-servers"][b],false,true)}}exodus.secondaryShown=true}},showSecondaryServers:function(a){for(var b=0;b<exodus.data["secondary-servers"].length;b++){exodus.appendServerRow(a,exodus.data["secondary-servers"][b],false,true)}exodus.secondaryShown=true},showDialog:function(){if(exodus.isOpen!=null){return}exodus.data={"load-image":exodus.indicator.attr("data-load-image"),"exodus-start":exodus.indicator.attr("data-exodus-start"),"exodus-end":exodus.indicator.attr("data-exodus-end"),"next-migration":exodus.indicator.attr("data-next-migration"),translations:$.parseJSON(exodus.indicator.attr("data-translations")),"migration-host":exodus.indicator.attr("data-migration-host"),"primary-servers":$.parseJSON(exodus.indicator.attr("data-primary-servers")),"secondary-servers":$.parseJSON(exodus.indicator.attr("data-secondary-servers")),"user-data":exodus.indicator.attr("data-user-data"),"user-validation":exodus.indicator.attr("data-user-validation"),"see-dialog":exodus.indicator.attr("data-user-see-dialog"),"ally-id":exodus.indicator.attr("data-user-ally-id")};if(exodus.data["user-validation"]==0){alert(exodus.data.translations["error-user-not-validated"]);return}exodus.isOpen=true;exodus.selectedServer=null;exodus.markedServer=null;exodus.dialog=$('<div id="exodus-dialog"/>');exodus.overlay=$('<div id="exodus-overlay"/>');var e=$('<div id="exodus-header"/>');var b=$('<div id="exodus-close"/>');var d=$('<div id="exodus-content"/>');var c=$('<div id="exodus-top-content"/>');var a=$('<ul id="exodus-tab-bar"/>');exodus.overlay.bind("click",exodus.closeDialog);b.bind("click",exodus.closeDialog);e.append($('<div id="exodus-header-content"/>').text(exodus.data.translations["exodus-dialog-title"]));c.text(exodus.data.translations["exodus-period"]+" "+exodus.data["exodus-start"]+" ??? "+exodus.data["exodus-end"]);if(exodus.data["next-migration"]!=""){c.append($('<span id="exodus-next-migration"/>').text(exodus.data["next-migration"]));c.append($("<span/>").text(": "+exodus.data.translations["next-migration-processing"]))}allyView=$('<li id="ally-show"/>').text(exodus.data.translations["tab-ally-mebers"]);allyView.bind("click",function(){exodus.showAllyMemberTab()});serverView=$('<li id="uni-select"/>').text(exodus.data.translations["tab-uni-selection"]);serverView.bind("click",function(){exodus.showServerSelection()});rulesView=$('<li id="rules-show"/>').text(exodus.data.translations["tab-rules"]);rulesView.bind("click",function(){exodus.showRulesTab()});a.append(serverView);if(exodus.data["ally-id"]>0){a.append(allyView)}a.append(rulesView);d.append(c).append(a);exodus.dialog.append(e).append(d).append(b);$("body").append(exodus.overlay).append(exodus.dialog);if(exodus.data["see-dialog"]=="0"){exodus.showRulesTab();exodus.data["see-dialog"]="1";exodus.indicator.attr("data-user-see-dialog",1);$.jsonp({url:"/service/exodus.php?action=seeDialog&data="+exodus.data["user-data"]+"&callback=?",error:function(f){alert("TEST: "+exodus.data["user-data"])},success:""})}else{exodus.showServerSelection()}},closeDialog:function(){exodus.dialog.remove();exodus.overlay.remove();exodus.isOpen=null},createButton:function(a){return $('<div class="exodus-button"/>').append($('<div class="exodus-button-left"/>')).append($('<div class="exodus-button-label"/>').text(a)).append($('<div class="exodus-button-right"/>'))},showServerSelection:function(){if($("#uni-select").hasClass("selected")){return}if($("#ally-show").hasClass("selected")){exodus.allyMemberContent.detach()}else{if($("#rules-show").hasClass("selected")){exodus.rulesContent.detach()}}$("#rules-show").removeClass("selected");$("#ally-show").removeClass("selected");$("#uni-select").addClass("selected");exodus.tabContent=$('<div id="exodus-tab-content"/>');exodus.showSelectionTab();exodus.tabContent.appendTo("#exodus-content")},showAllyMemberTab:function(){if($("#ally-show").hasClass("selected")){return}if($("#uni-select").hasClass("selected")){exodus.tabContent.detach()}else{if($("#rules-show").hasClass("selected")){exodus.rulesContent.detach()}}$("#uni-select").removeClass("selected");$("#rules-show").removeClass("selected");$("#ally-show").addClass("selected");if(exodus.allyMemberContent!=null){exodus.allyMemberContent.appendTo("#exodus-content")}else{exodus.allyMemberContent=$('<div id="exodus-ally-content"/>');$.jsonp({url:"/service/exodus.php?action=getAllyMemberSelection&data="+exodus.data["user-data"]+"&callback=?",error:function(){},success:function(a){if(a.errorMessage){exodus.closeDialog()}else{header=$('<div id="exodus-universe-treeview-header"/>').append($('<span class="exodus-universe-treeview-column-name"/>').text(exodus.data.translations["ally-members-name"])).append($('<span class="exodus-universe-treeview-column-startdate"/>').text(exodus.data.translations["ally-members-server"]));var b=$('<div id="exodus-universe-treeview"/>');for(i=0;i<a.length;i++){row=$('<li id="server-'+i+'" class="'+(i%2?"odd":"even")+'"/>').append($('<span class="exodus-universe-treeview-column-name"/>').text(a[i].db_character));if(a[i].server_name!=null){row.append($('<span class="exodus-universe-treeview-column-name"/>').text(a[i].server_name))}else{row.append($('<span class="exodus-universe-treeview-column-name"/>').text(exodus.data.translations["ally-member-no-selction"]))}b.append(row)}exodus.allyMemberContent.append(header);exodus.allyMemberContent.append(b);$("#exodus-content").append(exodus.allyMemberContent)}}})}},showRulesTab:function(){if($("#rules-show").hasClass("selected")){return}if($("#uni-select").hasClass("selected")){exodus.tabContent.detach()}else{if($("#ally-show").hasClass("selected")){exodus.allyMemberContent.detach()}}$("#uni-select").removeClass("selected");$("#ally-show").removeClass("selected");$("#rules-show").addClass("selected");rules=new Array("uni-fusion","pre-exodus","exodus-phase","post-exodus","exodus-uni","target-uni");if(exodus.rulesContent!=null){exodus.rulesContent.appendTo("#exodus-content")}else{exodus.rulesContent=$('<div id="exodus-rules-content"/>');rule=$('<div class="exodus_rule"/>');for(var a=0;a<rules.length;a++){rule.append($('<h2 class="exodus-rule-title" />').text(exodus.data.translations["title-"+rules[a]]));rule.append($('<p class="exodus-rule-description" />').text(exodus.data.translations["description-"+rules[a]]));exodus.rulesContent.append(rule)}$("#exodus-content").append(exodus.rulesContent)}}};